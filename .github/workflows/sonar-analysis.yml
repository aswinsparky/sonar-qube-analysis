name: SonarQube Analysis

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  sonar:
    runs-on: ubuntu-latest

    env:
      SONAR_HOST_URL: "http://13.223.150.126:9000"
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Run SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ env.SONAR_HOST_URL }}

      - name: Check .scannerwork output
        run: ls -R .scannerwork || echo ".scannerwork folder not found"

      - name: Wait for CE Task & Fetch Issues
        run: |
          sudo apt-get update && sudo apt-get install -y jq curl python3
          TASK_FILE=".scannerwork/report-task.txt"
          if [ ! -f "$TASK_FILE" ]; then
            echo "‚ùå report-task.txt NOT FOUND"
            exit 1
          fi
          CE_TASK_ID=$(grep 'ceTaskId' $TASK_FILE | cut -d '=' -f2)
          COMPONENT_KEY=$(grep -E 'componentKey|projectKey' $TASK_FILE | cut -d '=' -f2)
          STATUS="PENDING"
          ATTEMPTS=0
          MAX_ATTEMPTS=30
          while [[ "$STATUS" != "SUCCESS" && $ATTEMPTS -lt $MAX_ATTEMPTS ]]; do
            sleep 5
            CE_STATUS=$(curl -s -u "${{ secrets.SONAR_TOKEN }}:" \
              "${{ env.SONAR_HOST_URL }}/api/ce/task?id=$CE_TASK_ID")
            STATUS=$(echo "$CE_STATUS" | jq -r '.task.status')
            echo "Status: $STATUS (attempt $ATTEMPTS)"
            ATTEMPTS=$((ATTEMPTS+1))
          done
          if [ "$STATUS" != "SUCCESS" ]; then
            echo "‚ùå CE task did NOT finish"
            exit 1
          fi
          curl -s -u "${{ secrets.SONAR_TOKEN }}:" \
            "${{ env.SONAR_HOST_URL }}/api/issues/search?componentKeys=$COMPONENT_KEY&ps=500" \
            > sonar_issues.json
          cp sonar_issues.json sonar_issues_raw.json

          python3 - <<EOF
          import json, os
          with open('sonar_issues.json') as f:
              data = json.load(f)
          filtered = []
          for iss in data.get('issues', []):
              comp = iss.get('component') or ''
              path = comp.split(':', 1)[1] if ':' in comp else comp
              norm_path = os.path.normpath(path)
              candidates = [norm_path, './' + norm_path, norm_path.lstrip('./')]
              if any(os.path.exists(c) for c in candidates):
                  filtered.append(iss)
          with open('sonar_issues_filtered.json', 'w') as f:
              json.dump({'issues': filtered}, f)
          print(f"Filtered {len(filtered)} issues (from {len(data.get('issues', []))})")
          EOF

          jq -r '
            .issues[] |
            "Severity: \(.severity)\nRule: \(.rule)\nFile: \(.component)\nLine: \(.line)\nMessage: \(.message)\n---"
          ' sonar_issues_filtered.json > issue_summary.txt

      - name: Fetch SonarQube Metrics
        run: |
          TASK_FILE=".scannerwork/report-task.txt"
          COMPONENT_KEY=$(grep -E 'componentKey|projectKey' $TASK_FILE | cut -d '=' -f2)
          curl -s -u "${{ secrets.SONAR_TOKEN }}:" \
            "${{ env.SONAR_HOST_URL }}/api/measures/component?component=$COMPONENT_KEY&metricKeys=bugs,vulnerabilities,code_smells,coverage,duplicated_lines_density,complexity,security_hotspots,reliability_rating,security_rating,sqale_rating" \
            > sonar_metrics.json
          jq -r '.component.measures[] | "\(.metric): \(.value)"' sonar_metrics.json > sonar_metrics_summary.txt

      - name: Load issue summary content
        id: load_issues
        run: |
          echo "content<<EOF" >> $GITHUB_OUTPUT
          cat issue_summary.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Load metrics summary content
        id: load_metrics
        run: |
          echo "content<<EOF" >> $GITHUB_OUTPUT
          cat sonar_metrics_summary.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Python Security Check with Bandit, Upload to S3
        run: |
          pip install bandit awscli
          bandit -r src/ --exit-zero > Bandit_analysis.txt
          aws s3 cp Bandit_analysis.txt s3://${{ secrets.AWS_S3_BUCKET }}/Bandit_analysis.txt --region us-east-1
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Upload SonarQube Reports to S3
        run: |
          pip install --user awscli
          export PATH=$PATH:/home/runner/.local/bin
          BUCKET=${{ secrets.AWS_S3_BUCKET }}
          echo "S3 bucket: '${BUCKET:-<empty>}'"
          if [ -z "$BUCKET" ]; then
            echo "‚ùå AWS_S3_BUCKET secret is not set"
            exit 1
          fi
          aws s3 cp issue_summary.txt s3://$BUCKET/issue_summary.txt --region us-east-1
          aws s3 cp sonar_metrics_summary.txt s3://$BUCKET/sonar_metrics_summary.txt --region us-east-1
          aws s3 ls s3://$BUCKET || true
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Post Full Report in PR
        if: github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## üß™ SonarQube Analysis Report (FULL DETAILS)
            ### üîç Issues Summary  
            ```
            ${{ steps.load_issues.outputs.content }}
            ```
            ### üìä Metrics Summary  
            ```
            ${{ steps.load_metrics.outputs.content }}
            ```
            ### ‚òÅÔ∏è S3 Upload Status  
            ‚úî Uploaded: issue_summary.txt  
            ‚úî Uploaded: sonar_metrics_summary.txt  
            ‚úî Uploaded: Bandit_analysis.txt
<<<<<<< HEAD
=======

>>>>>>> 3b491fd4474181c4a6bbc0c8e1e2e7f3d16b82e4
