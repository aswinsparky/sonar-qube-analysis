name: SonarQube Analysis Inline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  sonar:
    runs-on: ubuntu-latest

    env:
      SONAR_HOST_URL: "http://13.223.150.126:9000"
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Run SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ env.SONAR_HOST_URL }}

      - name: Install jq and curl
        run: sudo apt-get update && sudo apt-get install -y jq curl

      - name: Wait for CE Task & Fetch Issues
        run: |
          TASK_FILE=".scannerwork/report-task.txt"
          if [ ! -f "$TASK_FILE" ]; then
            echo "‚ùå report-task.txt NOT FOUND"
            exit 1
          fi
          CE_TASK_ID=$(grep 'ceTaskId' $TASK_FILE | cut -d '=' -f2)
          COMPONENT_KEY=$(grep -E 'componentKey|projectKey' $TASK_FILE | cut -d '=' -f2)
          STATUS="PENDING"
          ATTEMPTS=0
          while [[ "$STATUS" != "SUCCESS" && $ATTEMPTS -lt 30 ]]; do
            sleep 5
            CE_STATUS=$(curl -s -u "${SONAR_TOKEN}:" "$SONAR_HOST_URL/api/ce/task?id=$CE_TASK_ID")
            STATUS=$(echo "$CE_STATUS" | jq -r '.task.status // empty')
            echo "Sonar CE Task: $STATUS (attempt $ATTEMPTS)"
            ATTEMPTS=$((ATTEMPTS + 1))
          done
          if [ "$STATUS" != "SUCCESS" ]; then
            echo "‚ùå CE task did NOT finish"
            exit 1
          fi
          curl -s -u "${SONAR_TOKEN}:" \
            "$SONAR_HOST_URL/api/issues/search?componentKeys=$COMPONENT_KEY&ps=500" \
            > sonar_issues.json
          python3 - <<EOF
          import json, os, tempfile
          try:
              with open("sonar_issues.json") as f:
                  data = json.load(f)
              filtered = []
              for iss in data.get("issues", []):
                  comp = iss.get("component", "")
                  path = comp.split(":", 1)[1] if ":" in comp else comp
                  if os.path.exists(path):
                      filtered.append(iss)
              fd, tempf = tempfile.mkstemp()
              with os.fdopen(fd, 'w') as f:
                  json.dump({"issues": filtered}, f)
              with open(tempf) as f:
                  _ = json.load(f)
              os.replace(tempf, "sonar_issues_filtered.json")
              print(f"Wrote {len(filtered)} filtered issues.")
          except Exception as e:
              print("Error filtering/writing issues; writing safe empty file:", e)
              with open("sonar_issues_filtered.json", "w") as f:
                  json.dump({"issues": []}, f)
          EOF

      # CREATE issue_summary.txt regardless of issues, so S3/report doesn't fail
      - name: Prepare issue_summary.txt
        run: |
          if python3 -c 'import sys, json; json.load(sys.stdin)' < sonar_issues_filtered.json >/dev/null 2>&1 && jq -e 'has("issues") and (.issues | length > 0)' sonar_issues_filtered.json >/dev/null; then
            jq -r '
              .issues[] |
              "Severity: \(.severity)\nRule: \(.rule)\nFile: \(.component)\nLine: \(.line)\nMessage: \(.message)\n---"
            ' sonar_issues_filtered.json > issue_summary.txt
          else
            echo "No issues found." > issue_summary.txt
          fi

      # Collect metrics (you need to have a metrics fetch here; add or adjust as needed)
      - name: Fetch SonarQube Metrics
        run: |
          COMPONENT_KEY=$(grep -E 'componentKey|projectKey' .scannerwork/report-task.txt | cut -d '=' -f2)
          curl -s -u "${SONAR_TOKEN}:" \
            "$SONAR_HOST_URL/api/measures/component?component=$COMPONENT_KEY&metricKeys=bugs,vulnerabilities,code_smells,coverage,duplicated_lines_density,complexity" \
            > sonar_metrics.json

      # CREATE sonar_metrics_summary.txt regardless of metrics
      - name: Prepare sonar_metrics_summary.txt
        run: |
          if jq -e 'has("component") and (.component.measures | length > 0)' sonar_metrics.json >/dev/null; then
            jq -r '.component.measures[] | "\(.metric): \(.value)"' sonar_metrics.json > sonar_metrics_summary.txt
          else
            echo "No metrics found." > sonar_metrics_summary.txt
          fi

      - name: Get changed files and changed lines in PR
        if: github.event_name == 'pull_request'
        id: diff
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr diff ${{ github.event.pull_request.number }} --name-only | sort | uniq > changed_files.txt
          gh pr diff ${{ github.event.pull_request.number }} --patch > pr.diff

          python3 - <<EOF
          import re, json
          def parse_diff(path):
              lines = {}
              curr_file = None
              lineno = None
              with open(path) as f:
                  for line in f:
                      # File header
                      m = re.match(r'^\+\+\+ b\/(.+)$', line)
                      if m:
                          curr_file = m.group(1)
                          lines[curr_file] = []
                      # Hunk header
                      m = re.match(r'^@@ \-(\d+),\d+ \+(\d+),(\d+) @@', line)
                      if m:
                          lineno = int(m.group(2))
                      # Added or changed line
                      if curr_file and lineno and (line.startswith('+') or line.startswith('-')):
                          if line.startswith('+'):
                              lines[curr_file].append(lineno)
                          lineno += 1
                      elif curr_file and lineno and not line.startswith('\\\\') and not line.startswith('@@'):
                          lineno += 1
              return lines
          changed = parse_diff("pr.diff")
          with open("changed_lines.json", "w") as f:
              json.dump(changed, f)
          EOF

      - name: Post SonarQube Inline Review Comments
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const issues = JSON.parse(fs.readFileSync('sonar_issues_filtered.json')).issues;
            const changed = JSON.parse(fs.readFileSync('changed_lines.json'));
            const commit_id = process.env.GITHUB_SHA || '${{ github.event.pull_request.head.sha }}';
            let comments = [];
            for (const issue of issues) {
              const comp = issue.component || "";
              const path = comp.includes(':') ? comp.split(':')[1] : comp;
              const line = issue.line || 1;
              if (!changed[path]) continue; // not a changed file
              if (!changed[path].includes(line)) continue; // not a changed line
              comments.push({
                path,
                line,
                side: 'RIGHT',
                body: `SonarQube ${issue.severity}: ${issue.message}`
              });
            }
            if (comments.length > 0) {
              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                commit_id,
                event: "COMMENT",
                comments
              });
            } else {
              console.log("No SonarQube issues to post as review.");
            }

      - name: Upload to S3
        run: |
          pip install --user awscli
          aws s3 cp issue_summary.txt s3://${{ secrets.AWS_S3_BUCKET }}/
          aws s3 cp sonar_metrics_summary.txt s3://${{ secrets.AWS_S3_BUCKET }}/
          aws s3 cp sonar_issues_filtered.json s3://${{ secrets.AWS_S3_BUCKET }}/
          aws s3 cp sonar_issues_raw.json s3://${{ secrets.AWS_S3_BUCKET }}/

      - name: Post Full Report to PR
        if: github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## üß™ SonarQube Analysis Report
            ### Issues
            ```
            ${{ steps.load_issues.outputs.content }}
            ```
            ### Metrics
            ```
            ${{ steps.load_metrics.outputs.content }}
            ```
            ### ‚òÅÔ∏è S3 Uploads
            ‚úî Uploaded: issue_summary.txt  
            ‚úî Uploaded: sonar_metrics_summary.txt  
            ‚úî Uploaded: sonar_issues_filtered.json  
            ‚úî Uploaded: sonar_issues_raw.json
