name: SonarQube Analysis Inline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  sonar:
    runs-on: ubuntu-latest

    env:
      SONAR_HOST_URL: "http://13.223.150.126:9000"
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Run SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ env.SONAR_HOST_URL }}

      - name: Install jq and curl
        run: sudo apt-get update && sudo apt-get install -y jq curl

      - name: Wait for CE Task & Fetch Issues
        run: |
          TASK_FILE=".scannerwork/report-task.txt"
          if [ ! -f "$TASK_FILE" ]; then
            echo "‚ùå report-task.txt NOT FOUND"
            exit 1
          fi
          CE_TASK_ID=$(grep 'ceTaskId' $TASK_FILE | cut -d '=' -f2)
          COMPONENT_KEY=$(grep -E 'componentKey|projectKey' $TASK_FILE | cut -d '=' -f2)
          STATUS="PENDING"
          ATTEMPTS=0
          while [[ "$STATUS" != "SUCCESS" && $ATTEMPTS -lt 30 ]]; do
            sleep 5
            CE_STATUS=$(curl -s -u "${SONAR_TOKEN}:" "$SONAR_HOST_URL/api/ce/task?id=$CE_TASK_ID")
            STATUS=$(echo "$CE_STATUS" | jq -r '.task.status // empty')
            echo "Sonar CE Task: $STATUS (attempt $ATTEMPTS)"
            ATTEMPTS=$((ATTEMPTS + 1))
          done
          if [ "$STATUS" != "SUCCESS" ]; then
            echo "‚ùå CE task did NOT finish"
            exit 1
          fi
          curl -s -u "${SONAR_TOKEN}:" \
            "$SONAR_HOST_URL/api/issues/search?componentKeys=$COMPONENT_KEY&ps=500" \
            > sonar_issues.json
          # Validate JSON with python; fallback to empty if broken/truncated
          if ! python3 -c 'import sys, json; json.load(sys.stdin)' < sonar_issues.json >/dev/null 2>&1; then
            echo '{"issues":[]}' > sonar_issues.json
            echo "[Fixed]: sonar_issues.json was invalid and replaced."
          fi
          # Validate structure for jq
          if ! jq -e 'has("issues") and (.issues | type == "array")' sonar_issues.json >/dev/null 2>&1; then
            echo '{"issues":[]}' > sonar_issues.json
            echo "[Fixed]: sonar_issues.json had missing/invalid issues array."
          fi
          cp sonar_issues.json sonar_issues_raw.json
          python3 - <<EOF
          import json, os
          try:
              with open("sonar_issues.json") as f:
                  data = json.load(f)
              filtered = []
              for iss in data.get("issues", []):
                  comp = iss.get("component", "")
                  path = comp.split(":", 1)[1] if ":" in comp else comp
                  if os.path.exists(path):
                      filtered.append(iss)
              with open("sonar_issues_filtered.json", "w") as f:
                  json.dump({"issues": filtered}, f)
          except Exception as e:
              print("Error filtering issues:", e)
              with open("sonar_issues_filtered.json", "w") as f:
                  json.dump({"issues": []}, f)
          EOF
          # Always create a summary file, handle empty
          if jq -e 'has("issues") and (.issues | length > 0)' sonar_issues_filtered.json >/dev/null; then
            jq -r '
              .issues[] |
              "Severity: \(.severity)\nRule: \(.rule)\nFile: \(.component)\nLine: \(.line)\nMessage: \(.message)\n---"
            ' sonar_issues_filtered.json > issue_summary.txt
          else
            echo "No issues found." > issue_summary.txt
          fi

      - name: Fetch SonarQube Metrics
        run: |
          COMPONENT_KEY=$(grep -E 'componentKey|projectKey' .scannerwork/report-task.txt | cut -d '=' -f2)
          curl -s -u "${SONAR_TOKEN}:" \
            "$SONAR_HOST_URL/api/measures/component?component=$COMPONENT_KEY&metricKeys=bugs,vulnerabilities,code_smells,coverage,duplicated_lines_density,complexity" \
            > sonar_metrics.json
          if jq -e 'has("component") and (.component.measures | length > 0)' sonar_metrics.json >/dev/null; then
            jq -r '.component.measures[] | "\(.metric): \(.value)"' sonar_metrics.json > sonar_metrics_summary.txt
          else
            echo "No metrics found." > sonar_metrics_summary.txt
          fi

      - name: Load issue summary content
        id: load_issues
        run: |
          echo "content<<EOF" >> $GITHUB_OUTPUT
          cat issue_summary.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Load metrics summary content
        id: load_metrics
        run: |
          echo "content<<EOF" >> $GITHUB_OUTPUT
          cat sonar_metrics_summary.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Get changed files in PR
        if: github.event_name == 'pull_request'
        run: |
          gh pr diff ${{ github.event.pull_request.number }} --name-only | sort | uniq > changed_files.txt
          cat changed_files.txt

      - name: Post Sonar Inline Comments
        if: github.event_name == 'pull_request'
        run: |
          echo "======= BEGIN RAW ISSUES FILTERED JSON ======="
          cat sonar_issues_filtered.json || echo "File missing!"
          echo "======= END RAW ISSUES FILTERED JSON ======="
          if ! python3 -c 'import sys, json; json.load(sys.stdin)' < sonar_issues_filtered.json >/dev/null 2>&1; then
            echo '{"issues":[]}' > sonar_issues_filtered.json
            echo "[Fixed]: sonar_issues_filtered.json was invalid and replaced."
          fi
          if ! jq -e 'has("issues") and (.issues | type == "array")' sonar_issues_filtered.json >/dev/null 2>&1; then
            echo '{"issues":[]}' > sonar_issues_filtered.json
            echo "[Fixed]: sonar_issues_filtered.json had missing/invalid issues array."
          fi
          ISSUES_COUNT=$(jq '.issues | length' sonar_issues_filtered.json)
          echo "Found $ISSUES_COUNT issues to process"
          if [ "$ISSUES_COUNT" -gt 0 ]; then
            jq -c '.issues[]' sonar_issues_filtered.json | while read issue; do
              FILE=$(echo "$issue" | jq -r '.component' | cut -d ":" -f2)
              LINE=$(echo "$issue" | jq -r '.line // 1')
              MSG=$(echo "$issue" | jq -r '.message // ""')
              SEVERITY=$(echo "$issue" | jq -r '.severity // ""')
              if grep -qx "$FILE" changed_files.txt; then
                BODY="**SonarQube $SEVERITY**: $MSG"
                ESCAPED=$(printf "%s" "$BODY" | jq -Rs .)
                echo "üí¨ Commenting ‚Üí $FILE:$LINE"
                curl -s -X POST \
                  -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                  -H "Accept: application/vnd.github+json" \
                  "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/comments" \
                  -d "{
                    \"body\": $ESCAPED,
                    \"commit_id\": \"${{ github.event.pull_request.head.sha }}\",
                    \"path\": \"$FILE\",
                    \"line\": $LINE
                  }"
              fi
            done
          else
            echo "No valid issues found for inline commenting."
          fi

      - name: Upload to S3
        run: |
          pip install --user awscli
          aws s3 cp issue_summary.txt s3://${{ secrets.AWS_S3_BUCKET }}/
          aws s3 cp sonar_metrics_summary.txt s3://${{ secrets.AWS_S3_BUCKET }}/
          aws s3 cp sonar_issues_filtered.json s3://${{ secrets.AWS_S3_BUCKET }}/
          aws s3 cp sonar_issues_raw.json s3://${{ secrets.AWS_S3_BUCKET }}/

      - name: Post Full Report to PR
        if: github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## üß™ SonarQube Analysis Report
            ### Issues
            ```
            ${{ steps.load_issues.outputs.content }}
            ```
            ### Metrics
            ```
            ${{ steps.load_metrics.outputs.content }}
            ```
            ### ‚òÅÔ∏è S3 Uploads
            ‚úî Uploaded: issue_summary.txt  
            ‚úî Uploaded: sonar_metrics_summary.txt  
            ‚úî Uploaded: sonar_issues_filtered.json  
            ‚úî Uploaded: sonar_issues_raw.json
